{% extends "base.html" %}

{% block title %}{{ video.title }}{% endblock %}

{% block content %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var videoId = '{{ video.url_path }}';

        document.getElementById('shareLink').addEventListener('click', function(event) {
            event.preventDefault();
            var videoUrl = window.location.origin + '/videos/' + videoId + '/';
            navigator.clipboard.writeText(videoUrl).then(function() {
                alert('Link to this video has been copied to clipboard.');
            }, function(err) {
                console.error('Failed to copy link: ', err);
            });
        });

        var video = document.getElementById('videoElement');
        var hasBeenCounted = false;

        video.addEventListener('timeupdate', function() {
            var threshold = video.duration * 0.25;

            if (!hasBeenCounted && video.currentTime >= threshold) {
                hasBeenCounted = true;

                fetch(`/update_views/${videoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => console.log(data.message))
                .catch(error => console.error('Error:', error));
            }
        });

        document.querySelectorAll('.like-button, .dislike-button').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const like = this.dataset.like === 'true';
                sendLikeDislikeRequest(videoId, like);
            });
        });

        function sendLikeDislikeRequest(videoId, like) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(`/like_dislike/video/${videoId}/${like ? 'like' : 'dislike'}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'like': like }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.querySelector(`#likes-count`).innerText = data.num_likes;
                document.querySelector(`#dislikes-count`).innerText = data.num_dislikes;
            })
            .catch(error => console.error('Error:', error));
        }
    });
</script>

<h1>{{ video.title }}</h1>
<video id="videoElement" width="320" height="240" controls>
    <source src="{{ video.video_file.url }}" type="video/mp4">
    Your browser does not support video tags.
</video>

<p class="date">
    Published {{ video.uploaded_at }} by {{ video.author.username }} Views: {{ video.views }}
</p>
<p class="description">
    {{ video.description }}
</p>
<a href="#" id="shareLink">Share video</a>

<div class="like-dislike-buttons">
    <button type="button" class="like-button" data-video-id="{{ video.url_path }}" data-like="true">Like</button>
    <span id="likes-count">{{ video.num_likes }}</span>
    <button type="button" class="dislike-button" data-video-id="{{ video.url_path }}" data-like="false">Dislike</button>
    <span id="dislikes-count">{{ video.num_dislikes }}</span>
</div>

<h2>Similar posts</h2>
{% for similar_video in similar_videos %}
<p>
    <a href="{{ similar_video.get_absolute_url }}">{{ similar_video.title }}</a>
</p>
{% empty %}
No similar posts yet
{% endfor %}
{% endblock %}
